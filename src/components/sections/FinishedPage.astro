---
import EmptyResponse from "@components/EmptyResponse.astro"
import Section from "@components/Section.astro"
import Row from "@components/ui/Row.astro"
import type { AnimeData } from "@interfaces/animeResponse"
import { Finished as FinishedDB, db, eq } from "astro:db"

interface FinishedInterface {
	userId: number
	malId: number
	malItem: AnimeData
}

interface LoaderData {
	finishedList: FinishedInterface[]
	emptyText: {
		title: string
		text: string
	}
}

const loader = async (): Promise<LoaderData> => {
	const emptyText = {
		title: "Ops!",
		text: "üôÅ A√∫n no tienes series en tu lista de finalizadas",
	}
	const finishedList: FinishedInterface[] | null = (await db
		.select()
		.from(FinishedDB)
		.where(eq(FinishedDB.userId, 1))) as FinishedInterface[] | null

	return { finishedList, emptyText } as LoaderData
}

const { finishedList, emptyText } = await loader()

const buttonText = "ELIMINAR"
---

<Section title="Viendo">
	{
		finishedList.length > 0 ? (
			finishedList.map(({ malItem }) => (
				<Row
					title={malItem.title}
					text={malItem.synopsis}
					image={malItem.images.webp.image_url}
					buttonText={buttonText}
				/>
			))
		) : (
			<EmptyResponse title={emptyText.title} text={emptyText.text} />
		)
	}
</Section>
